library(shiny)
library(DBI)
library(RMySQL)
library(shinydashboard)
library(leaflet)
library(flexdashboard)



options(repos = c(CRAN = "http://cran.rstudio.com"))#function that kills all mysql connections
killDbConnections <- function () {
  all_cons <- dbListConnections(MySQL())
  print(all_cons)
  for(con in all_cons)
    +  dbDisconnect(con)
  print(paste(length(all_cons), " connections killed."))
}

# server code to start the shiny app
server<-function(input, output,session) {
  
  # Kill all mysql connections before starting
  killDbConnections()
  
  #connection to azure mysql database (cloud)
  db = dbConnect(MySQL(),
                 dbname = "accidents",
                 host = "shinyapp.mysql.database.azure.com", 
                 user = "myadmin@shinyapp", 
                 password = "Shinyapp69")
  
  #disconnect when exiting the app
  on.exit(dbDisconnect(db), add = TRUE)
  # query to import dataframe for the map
 query <- paste0("SELECT d.nom_departement,latitude, longitude, count(distinct num_accident) as nombre
                FROM departement d
                  join accident a on a.departement_id = d.departement_id
                  group by d.departement_id")
 
  dept<- dbGetQuery(db, query) 
  
  
  
  #we create the data frame 
  villes <- data.frame(nom = dept$nom_departement,
                       lat = as.double(dept$latitude),
                       long = as.double(dept$longitude),
                       nombre = dept$nombre)
  
  couleurs <- colorNumeric("RdYlBu", dept$nombre, n = 10)
  # reactive function that creates the map using leaflet library
  output$mymap <- renderLeaflet({
    yourMap <- leaflet(dept) %>% addTiles() %>%
      addCircles(lng = ~longitude, lat = ~latitude,
                 weight = 1,
                 radius = ~sqrt(nombre) * 300, 
                 popup = ~paste(nom_departement, ":", nombre),
                 color = ~couleurs(nombre), fillOpacity = 0.9) %>%
      addLegend(pal = couleurs, values = ~nombre, opacity = 0.9)
  })
  

  dimensionInput <- reactive({
    switch(input$dimension,
           "region" = region
           #"dim_region" = table2
           
    )
  })
  
  if (interactive()) {
    observe  ({
      x <- input$dimension
      db = dbConnect(MySQL(),
                     dbname = "accidents",
                     host = "shinyapp.mysql.database.azure.com", 
                     user = "myadmin@shinyapp", 
                     password = "Shinyapp69")
      
      col_names <- sprintf ("show columns from %s", x)
      col_names_result <- dbGetQuery(db, col_names)
      # Can use character(0) to remove all choices
      if (is.null(x))
        x <- character(0)
            # Can also set the label and select items
      updateSelectInput(session, "attribute",
                        label = paste("Select attribute"),
                        choices = col_names_result$Field,
                        selected = tail(col_names_result$Field, 1)
      )
    })
  }
  

  attributeInput <- reactive({
    db = dbConnect(MySQL(),
                   dbname = "accidents",
                   host = "shinyapp.mysql.database.azure.com", 
                   user = "myadmin@shinyapp", 
                   password = "Shinyapp69")
    query1 <- sprintf ("select %s as attribut, count(distinct num_accident) as nombre FROM
                       %s x
                       join accident a on a.%s_id = x.%s_id
                       group by 1",input$attribute, input$dimension, input$dimension, input$dimension)
    
    result <- dbGetQuery(db, query1)
  })
  
  # Show the first "n" observations
  output$view <- renderPlot({
  donnee <- attributeInput()

    barplot(donnee$nombre , 
           las=2,
            names.arg = donnee$attribut,
            ylab="Number of accidents",
            xlab="attribut"
   )   
  })
  
 
  output$progressBox <- renderInfoBox({
    infoBox(
      "Progress", paste0(25 + input$count, "%"), icon = icon("list"),
      color = "purple"
    )
  })
  output$approvalBox <- renderInfoBox({
    infoBox(
      "Approval", "80%", icon = icon("thumbs-up", lib = "glyphicon"),
      color = "yellow"
    )
  })
  output$progressBox2 <- renderInfoBox({
    infoBox(
      "Progress", paste0(25 + input$count, "%"), icon = icon("list"),
      color = "purple", fill = TRUE
    )
  })
  
  output$approvalBox2 <- renderInfoBox({
    infoBox(
      "Approval", "80%", icon = icon("thumbs-up", lib = "glyphicon"),
      color = "yellow", fill = TRUE
    )
  })
  
  lumiere <- sprintf("select lumiere , count(distinct num_accident) as nombre FROM
                   caracteristiques x
                   join accident a on a.caracteristiques_id = x.caracteristiques_id
                   
                   group by 1 order by nombre desc ")
  
  lumiere_result <- dbGetQuery(db, lumiere)
  lumiere_result_pourecent <- ceiling(lumiere_result$nombre[1] * 100 / sum(lumiere_result$nombre))
 
   output$plt1 <- flexdashboard::renderGauge({
    gauge(lumiere_result_pourecent, min = 0, max = 100, symbol = '%', label = paste(lumiere_result$lumiere[1]),gaugeSectors(
      success = c(100, 6), warning = c(5,1), danger = c(0, 1), colors = c("#CC6699")
    ))
    
     })
   
   atmosphere <- ("select atmosphere , count(distinct num_accident) as nombre FROM
                  caracteristiques x
                  join accident a on a.caracteristiques_id = x.caracteristiques_id
                  group by 1 order by nombre desc ")
   
   atmosphere_result <- dbGetQuery(db, atmosphere)
   atmosphere_result_pourecent <- ceiling(atmosphere_result$nombre[1] * 100 / sum(atmosphere_result$nombre))
   
   
   output$plt2 <- flexdashboard::renderGauge({
     gauge(atmosphere_result_pourecent, min = 0, max = 100, symbol = '%', label = paste(atmosphere_result$atmosphere[1]),gaugeSectors(
       success = c(100, 6), warning = c(5,1), danger = c(0, 1), colors = c("#CC6699")
     ))
     
   })
   
   vehicule <- ("select categorie_vehicule as categorie , count(distinct num_accident) as nombre FROM
                  vehicule x
                  join accident a on a.vehicule_id = x.vehicule_id
                  group by 1 order by nombre desc ")
   
   vehicule_result <- dbGetQuery(db, vehicule)
   vehicule_result_pourecent <- ceiling(vehicule_result$nombre[1] * 100 / sum(vehicule_result$nombre))
   
   
   output$plt3 <- flexdashboard::renderGauge({
     gauge(vehicule_result_pourecent, min = 0, max = 100, symbol = '%', label = paste(vehicule_result$categorie[1]),gaugeSectors(
       success = c(100, 6), warning = c(5,1), danger = c(0, 1), colors = c("#CC6699")
     ))
     
   })
   
}